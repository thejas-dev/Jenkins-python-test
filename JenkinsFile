pipeline{
    agent { docker { image 'python:3.13.0-alpine3.20' } }
    triggers {
        pollSCM '* * * * *'
    }
    stages{
        stage('Build'){
            steps{
                echo 'From Build'
                sh '''
                    echo Multiline Text from build text
                ''' 
                sh 'python3 test.py'   
            }
        }
        stage('Test'){
            steps{
                echo 'From Test'
                sh '''
                    echo Multiline Text from test text
                ''' 
                sh '''
                    python3 - << EOF
print("Hello from Python Script!")

# Example logic in Python
def greet(name):
    return f"Hello, {name}!"

print(greet("Thejas"))
EOF
                '''
            }
        }
        stage('deploy'){
            steps{
                echo 'From Deploy'
                sh '''
                    echo Multiline Text from deploy text
                ''' 
            }
        }
    }
    post{
        success{
            script{
                def emailBody = readFile('success-template.html')
                emailBody = replaceVariables(emailBody)
                sendEmail(emailBody)
            }   
        }
        failure{
            script{
                def emailBody = readFile('failure-template.html')
                emailBody = replaceVariables(emailBody)
                sendEmail(emailBody)
            }
        }
    }
}

def sendEmail(body){
    mail(
        to: 'thejaskala308@gmail.com',
        subject: 'Email From Jenkins Pipeline', 
        mimeType: 'text/html',
        body: body
    )
}

def replaceVariables(template){
    return template
    .replaceAll('\\$BUILD_NUMBER',env.BUILD_NUMBER)
    .replaceAll('\\$env.JOB_NAME',env.JOB_NAME)
    .replaceAll('\\$currentBuild.currentResult',currentBuild.currentResult)
}